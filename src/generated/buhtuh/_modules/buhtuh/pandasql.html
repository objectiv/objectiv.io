
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>buhtuh.pandasql &#8212; BuhTuh  documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.e1d10f7563df45715c86914749a6789c.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/blank.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.baa8d61b9335871b5b4b.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../index.html">
<p class="title">BuhTuh</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    
    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/objectiv-analytics/buhtuh/" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/objectiv" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for buhtuh.pandasql</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">abstractmethod</span><span class="p">,</span> <span class="n">ABC</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">sql_models.model</span> <span class="kn">import</span> <span class="n">SqlModel</span><span class="p">,</span> <span class="n">CustomSqlModel</span>
<span class="kn">from</span> <span class="nn">sql_models.sql_generator</span> <span class="kn">import</span> <span class="n">to_sql</span>
<span class="kn">from</span> <span class="nn">buhtuh.types</span> <span class="kn">import</span> <span class="n">get_series_type_from_dtype</span><span class="p">,</span> <span class="n">arg_to_type</span>


<span class="n">DataFrameOrSeries</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;BuhTuhDataFrame&#39;</span><span class="p">,</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="BuhTuhDataFrame"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame">[docs]</a><span class="k">class</span> <span class="nc">BuhTuhDataFrame</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">engine</span><span class="p">,</span>
        <span class="n">source_node</span><span class="p">:</span> <span class="n">SqlModel</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">],</span>
        <span class="n">series</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: improve this docstring</span>
<span class="sd">        :param engine: db connection</span>
<span class="sd">        :param source_node: sqlmodel, must contain all expressions in series</span>
<span class="sd">        :param index: Dictionary mapping the name of each index-column to a Series object representing</span>
<span class="sd">            the column.</span>
<span class="sd">        :param series: Dictionary mapping the name of each data-column to a Series object representing</span>
<span class="sd">            the column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_node</span> <span class="o">=</span> <span class="n">source_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">series</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Keys in `series` should match the name of series. &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">, series.name: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The names of the index series and data series should not intersect. &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;Index series: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2"> data series: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_node</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SqlModel</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_node</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_series</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">column</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">column</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_dtypes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="n">CustomSqlModel</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="s1">&#39;select * from {{previous}} limit 0&#39;</span><span class="p">)(</span><span class="n">previous</span><span class="o">=</span><span class="n">node</span><span class="p">)</span>
        <span class="n">select_statement</span> <span class="o">=</span> <span class="n">to_sql</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            create temporary table tmp_table_name on commit drop as</span>
<span class="s2">            (</span><span class="si">{</span><span class="n">select_statement</span><span class="si">}</span><span class="s2">);</span>
<span class="s2">            select column_name, data_type</span>
<span class="s2">            from information_schema.columns</span>
<span class="s2">            where table_name = &#39;tmp_table_name&#39;</span>
<span class="s2">            order by ordinal_position;</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()}</span>

<div class="viewcode-block" id="BuhTuhDataFrame.from_table"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.from_table">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhDataFrame&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CustomSqlModel</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">instantiate</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_node</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhDataFrame.from_model"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.from_model">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">SqlModel</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhDataFrame&#39;</span><span class="p">:</span>
        <span class="c1"># Wrap the model in a simple select, so we know for sure that the top-level model has no unexpected</span>
        <span class="c1"># select expressions, where clauses, or limits</span>
        <span class="n">wrapped_model</span> <span class="o">=</span> <span class="n">CustomSqlModel</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="s1">&#39;SELECT * FROM {{model}}&#39;</span><span class="p">)(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_node</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">wrapped_model</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_from_node</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">SqlModel</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhDataFrame&#39;</span><span class="p">:</span>
        <span class="n">dtypes</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_dtypes</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

        <span class="n">index_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">dtypes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">index</span><span class="p">}</span>
        <span class="n">series_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">dtypes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index</span><span class="p">}</span>

        <span class="c1"># Should this also use _df_or_series?</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">source_node</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">index_dtypes</span><span class="o">=</span><span class="n">index_dtypes</span><span class="p">,</span>
            <span class="n">dtypes</span><span class="o">=</span><span class="n">series_dtypes</span>
        <span class="p">)</span>

<div class="viewcode-block" id="BuhTuhDataFrame.from_dataframe"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.from_dataframe">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dataframe</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># for now only one index allowed</span>
            <span class="n">index</span> <span class="o">=</span> <span class="s1">&#39;_index_0&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_index_</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Todo, this should use from_table from here on.</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CustomSqlModel</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;SELECT * FROM </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">instantiate</span><span class="p">()</span>

        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="n">column_name</span><span class="p">:</span> <span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="c1"># Should this also use _df_or_series?</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">source_node</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">index_dtypes</span><span class="o">=</span><span class="p">{</span><span class="n">index</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">},</span>
            <span class="n">dtypes</span><span class="o">=</span><span class="n">dtypes</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhDataFrame.get_instance"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.get_instance">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_instance</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span>
            <span class="n">engine</span><span class="p">,</span>
            <span class="n">source_node</span><span class="p">:</span> <span class="n">SqlModel</span><span class="p">,</span>
            <span class="n">index_dtypes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
            <span class="n">dtypes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhDataFrame&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an instance with the right series instantiated based on the dtypes array. This assumes that</span>
<span class="sd">        source_node has a column for all names in index_dtypes and dtypes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">index_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">index_type</span> <span class="o">=</span> <span class="n">get_series_type_from_dtype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_type</span><span class="p">(</span>
                <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
                <span class="n">base_node</span><span class="o">=</span><span class="n">source_node</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># No index for index</span>
                <span class="n">name</span><span class="o">=</span><span class="n">key</span>
            <span class="p">)</span>
        <span class="n">series</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">series_type</span> <span class="o">=</span> <span class="n">get_series_type_from_dtype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">series</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">series_type</span><span class="p">(</span>
                <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
                <span class="n">base_node</span><span class="o">=</span><span class="n">source_node</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">key</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">BuhTuhDataFrame</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">source_node</span><span class="o">=</span><span class="n">source_node</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
            <span class="n">series</span><span class="o">=</span><span class="n">series</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_df_or_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="s1">&#39;BuhTuhDataFrame&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrameOrSeries</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Figure out whether there is just one series in our data, and return that series instead of the</span>
<span class="sd">        whole frame.</span>
<span class="sd">        :param df: the df</span>
<span class="sd">        :return: BuhTuhDataFrame, BuhTuhSeries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="s1">&#39;BuhTuhSeriesBoolean&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DataFrameOrSeries</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: Comments</span>
<span class="sd">        :param key:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">key_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">selected_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">data</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_set</span><span class="p">}</span>

            <span class="k">return</span> <span class="n">BuhTuhDataFrame</span><span class="p">(</span>
                    <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
                    <span class="n">source_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_node</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                    <span class="n">series</span><span class="o">=</span><span class="n">selected_data</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_node</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_or_series</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">BuhTuhDataFrame</span><span class="p">(</span>
                    <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
                    <span class="n">source_node</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                    <span class="n">series</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">BuhTuhSeriesBoolean</span><span class="p">):</span>
            <span class="c1"># We only support first level boolean indices for now</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">base_node</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_node</span><span class="p">)</span>
            <span class="n">model_builder</span> <span class="o">=</span> <span class="n">CustomSqlModel</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;boolean_selection&#39;</span><span class="p">,</span>
                <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;select </span><span class="si">{index_str}</span><span class="s1">, </span><span class="si">{columns_sql_str}</span><span class="s1"> from {{_last_node}} where </span><span class="si">{where}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model_builder</span><span class="p">(</span>
                <span class="n">columns_sql_str</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_all_column_expressions</span><span class="p">(),</span>
                <span class="n">index_str</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                <span class="n">_last_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_node</span><span class="p">,</span>
                <span class="n">where</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_or_series</span><span class="p">(</span>
                <span class="n">BuhTuhDataFrame</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span>
                    <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
                    <span class="n">source_node</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">index_dtypes</span><span class="o">=</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
                    <span class="n">dtypes</span><span class="o">=</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only str, (set|list)[str], slice or BuhTuhSeriesBoolean are supported, &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                    <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">):</span>
                <span class="n">series</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">series</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># two cases:</span>
                <span class="c1"># 1) these share the same base_node and index</span>
                <span class="c1"># 2) these share the same index, but not the same base_node</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Index of assigned value does not match index of DataFrame. &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;Value: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1">, df: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">base_node</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_node</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">BuhTuhSeries</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span>
                        <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">expression</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">expression</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># this is the complex case. Maybe don&#39;t support this at all?TODO</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;TODO&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="c1"># len(key) &gt; 1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BuhTuhDataFrame</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Assigned value should be a BuhTuhDateFrame, provided: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data_columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of columns in key and value should match. &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;Key: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s1">, value: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data_columns</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">series_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">data_columns</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sub_key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">sub_key</span><span class="p">,</span> <span class="n">series_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Key should be either a string or a list of strings, value: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BuhTuhDataFrame.astype"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.astype">[docs]</a>    <span class="k">def</span> <span class="nf">astype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhDataFrame&#39;</span><span class="p">:</span>
        <span class="c1"># Check and/or convert parameters</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="n">column</span><span class="p">:</span> <span class="n">dtype</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dtype should either be a string or a dictionary mapping to strings.&#39;</span><span class="p">)</span>
        <span class="n">not_existing_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">not_existing_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Specified columns do not exist: </span><span class="si">{</span><span class="n">not_existing_columns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Construct new dataframe with converted columns</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_dtype</span><span class="p">:</span>
                <span class="n">new_data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">new_dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">series</span>

        <span class="k">return</span> <span class="n">BuhTuhDataFrame</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">source_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_node</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">series</span><span class="o">=</span><span class="n">new_data</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhDataFrame.groupby"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.groupby">[docs]</a>    <span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">by</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhGroupBy&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Group by any of the series currently in this dataframe, both from index</span>
<span class="sd">        as well as data.</span>
<span class="sd">        :param by: The series to group by</span>
<span class="sd">        :return: an object to perform aggregations on</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_by_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">group_by_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_series</span><span class="p">[</span><span class="n">by</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">):</span>
            <span class="n">group_by_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">by</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">by_item</span> <span class="ow">in</span> <span class="n">by</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">by_item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">group_by_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_series</span><span class="p">[</span><span class="n">by_item</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">by_item</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">):</span>
                    <span class="n">group_by_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">by_item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Value of &quot;by&quot; should be either None, a string, or a Series.&#39;</span><span class="p">)</span>

        <span class="c1"># TODO We used to create a new instance of this df before passing it on. Did that have value?</span>

        <span class="k">return</span> <span class="n">BuhTuhGroupBy</span><span class="p">(</span><span class="n">buh_tuh</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_by_columns</span><span class="o">=</span><span class="n">group_by_columns</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhDataFrame.sort_values"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.sort_values">[docs]</a>    <span class="k">def</span> <span class="nf">sort_values</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">by</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="n">ascending</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhDataFrame&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: comments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO needs type check?</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="n">by</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ascending</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">ascending</span> <span class="o">=</span> <span class="p">[</span><span class="n">ascending</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">by</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">by</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ascending</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Length of ascending (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ascending</span><span class="p">)</span><span class="si">}</span><span class="s1">) != length of by (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">by</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">sort_order</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="n">ascending</span><span class="p">))</span>
        <span class="n">possible_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sort_order</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possible_names</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Some series could not be found in current frame: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_node</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">sort_order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">BuhTuhDataFrame</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">source_node</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">index_dtypes</span><span class="o">=</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
            <span class="n">dtypes</span><span class="o">=</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhDataFrame.to_df"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.to_df">[docs]</a>    <span class="k">def</span> <span class="nf">to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_sql</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="BuhTuhDataFrame.head"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.head">[docs]</a>    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the first `n` rows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_sql</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="BuhTuhDataFrame.get_current_node"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.get_current_node">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">limit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SqlModel</span><span class="p">[</span><span class="n">CustomSqlModel</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap the current set op series in a model builder</span>
<span class="sd">        :param limit: The limit to use</span>
<span class="sd">        :param order: The data series to order by, where the bool specifies ASC or DESC.</span>
<span class="sd">                      If missing will use index ASC otherwise)</span>
<span class="sd">        :return: The model builder for the current state</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

        <span class="n">limit_str</span> <span class="o">=</span> <span class="s1">&#39;limit all&#39;</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">limit</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Step size not supported in slice&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">limit</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">limit</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">limit</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">limit</span><span class="o">.</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Negative start or stop not supported in slice&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">limit</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">limit</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">limit</span><span class="o">.</span><span class="n">stop</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;limit.stop &lt;= limit.start&#39;</span><span class="p">)</span>
                    <span class="n">limit_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;limit </span><span class="si">{</span><span class="n">limit</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">limit</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s1"> offset </span><span class="si">{</span><span class="n">limit</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">limit_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;limit all offset </span><span class="si">{</span><span class="n">limit</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">limit</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">limit_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;limit </span><span class="si">{</span><span class="n">limit</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">order_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;asc&#39;</span> <span class="k">if</span> <span class="n">asc</span> <span class="k">else</span> <span class="s1">&#39;desc&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">asc</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">order_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;order by </span><span class="si">{</span><span class="n">order_str</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">model_builder</span> <span class="o">=</span> <span class="n">CustomSqlModel</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;view_sql&#39;</span><span class="p">,</span>
            <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;select </span><span class="si">{index_str}</span><span class="s1">, </span><span class="si">{columns_sql_str}</span><span class="s1"> from {{_last_node}} </span><span class="si">{order}</span><span class="s1"> </span><span class="si">{limit}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">model_builder</span><span class="p">(</span>
            <span class="n">columns_sql_str</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_all_column_expressions</span><span class="p">(),</span>
            <span class="n">index_str</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">_last_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_node</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">limit_str</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">limit_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="n">order_str</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhDataFrame.view_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.view_sql">[docs]</a>    <span class="k">def</span> <span class="nf">view_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_node</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="n">to_sql</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sql</span></div>

<div class="viewcode-block" id="BuhTuhDataFrame.get_all_column_expressions"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.get_all_column_expressions">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_column_expressions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_alias</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">column_expressions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
            <span class="n">column_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">get_column_expression</span><span class="p">(</span><span class="n">table_alias</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_expressions</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhDataFrame.merge"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhDataFrame.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">DataFrameOrSeries</span><span class="p">,</span>
              <span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span>
                  <span class="n">Union</span><span class="p">[</span>
                      <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
                  <span class="p">]</span>
              <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">how</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhDataFrame&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge this dataframe to another.</span>

<span class="sd">        :param other: the df or series(right) to merge into ourself (left)</span>
<span class="sd">        :param conditions:</span>
<span class="sd">                    None (default): merge on index</span>
<span class="sd">                    List of conditions to use:</span>
<span class="sd">                        * str: use the series that exist on both sides with the same name to merge</span>
<span class="sd">                        * BuhTuhSeries: use the name of this series to find the series on both sides</span>
<span class="sd">                        * Tuple (str, str), (str, BuhTuhSeries), (BuhTuhSeries, str),</span>
<span class="sd">                            or (BuhTuhSeries,BuhTuhSeries): match the combinations as specified</span>

<span class="sd">        :param how: left, right, inner (default)</span>
<span class="sd">        :return: a freshly merged df</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">BuhTuhDataFrame</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Merging with a Series that is an index is not supported.&#39;</span><span class="p">)</span>

        <span class="c1"># Merge on index if matching and no conditions given</span>
        <span class="k">if</span> <span class="n">conditions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">other_index</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">self_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">other_index</span> <span class="o">==</span> <span class="n">self_index</span><span class="p">:</span>
                <span class="n">conditions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merge without conditions without matching indices &quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;not supported: </span><span class="si">{</span><span class="n">self_index</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">other_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">left_all</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">):</span>
            <span class="n">right_all</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">other</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">other</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">right_all</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">other</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="o">**</span><span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>

        <span class="n">new_series</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">column_sql</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># test whether how is valid and use as a selector</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">how</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">index_lr</span> <span class="o">=</span> <span class="s1">&#39;lrl&#39;</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">left_all</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">right_all</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>

        <span class="c1"># create new set of series after merge is done</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">left_all</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">right_all</span><span class="p">:</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">left_all</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">right_all</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="c1"># duplicate, keep both only if from different nodes</span>
                <span class="c1"># this is quite weak duplicate resolution, but okay for now</span>
                <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">base_node</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">base_node</span><span class="p">:</span>
                    <span class="n">left_uq</span> <span class="o">=</span> <span class="n">BuhTuhSeries</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                        <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_left&#39;</span><span class="p">,</span>
                                                        <span class="n">dtype</span><span class="o">=</span><span class="n">left</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                                        <span class="n">expression</span><span class="o">=</span><span class="n">left</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
                    <span class="n">new_series</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_left&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_uq</span>
                    <span class="n">column_sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left_uq</span><span class="o">.</span><span class="n">get_column_expression</span><span class="p">(</span><span class="n">table_alias</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">))</span>

                    <span class="n">right_uq</span> <span class="o">=</span> <span class="n">BuhTuhSeries</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                         <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_right&#39;</span><span class="p">,</span>
                                                         <span class="n">dtype</span><span class="o">=</span><span class="n">right</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                                         <span class="n">expression</span><span class="o">=</span><span class="n">right</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
                    <span class="n">new_series</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">right_uq</span>
                    <span class="n">column_sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">right_uq</span><span class="o">.</span><span class="n">get_column_expression</span><span class="p">(</span><span class="n">table_alias</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># not unique, keep one</span>
                    <span class="n">new_series</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span>
                    <span class="n">column_sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">get_column_expression</span><span class="p">(</span><span class="n">table_alias</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">left_all</span><span class="p">:</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">left_all</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">new_series</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span>
                <span class="n">column_sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">get_column_expression</span><span class="p">(</span><span class="n">table_alias</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># right only</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">right_all</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">new_series</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span>
                <span class="n">column_sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">get_column_expression</span><span class="p">(</span><span class="n">table_alias</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>

        <span class="n">on_conditions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">use_using</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
            <span class="c1"># Convert string indexed columns in data to their Series representation</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_all</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">right_all</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">):</span>
                <span class="c1"># convert single to tuple</span>
                <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_all</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">right_all</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

            <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span>  <span class="c1"># type: ignore  ## TODO: clean up this function so we don&#39;t reuse variables</span>

            <span class="c1"># convert to BuhTuhSeries if str</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">left_all</span><span class="p">[</span><span class="n">left</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">right_all</span><span class="p">[</span><span class="n">right</span><span class="p">]</span>

            <span class="c1"># Make sure the series are actually there (will actually raise KeyError before raising</span>
            <span class="c1"># AssertionError)</span>
            <span class="k">assert</span> <span class="n">left_all</span><span class="p">[</span><span class="n">left</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="ow">and</span> <span class="n">right_all</span><span class="p">[</span><span class="n">right</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

            <span class="c1"># if names are not equal, or one of the series is actually an expression, we cannot use</span>
            <span class="c1"># &quot;USING(...)&quot;</span>
            <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> \
                    <span class="n">left</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">left</span><span class="o">.</span><span class="n">get_expression</span><span class="p">()</span> <span class="ow">or</span> \
                    <span class="n">right</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">get_expression</span><span class="p">():</span>
                <span class="n">use_using</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">on_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">use_using</span><span class="p">:</span>
            <span class="n">condition_str</span> <span class="o">=</span> <span class="s1">&#39;USING (</span><span class="si">{fields}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">left</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">on_conditions</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">condition_str</span> <span class="o">=</span> <span class="s2">&quot;ON </span><span class="si">{expr}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">expr</span><span class="o">=</span><span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;</span><span class="si">{left}</span><span class="s1"> = </span><span class="si">{right}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">),</span>
                        <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                    <span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span> <span class="ow">in</span> <span class="n">on_conditions</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">model_builder</span> <span class="o">=</span> <span class="n">CustomSqlModel</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;merge_sql&#39;</span><span class="p">,</span>
            <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;select </span><span class="si">{index_str}</span><span class="s1">, </span><span class="si">{columns_sql_str}</span><span class="s1"> &#39;</span>
                <span class="s1">&#39;from {{left_node}} as l </span><span class="si">{join}</span><span class="s1"> JOIN {{right_node}} as r </span><span class="si">{condition_str}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_builder</span><span class="p">(</span>
            <span class="n">index_str</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">get_column_expression</span><span class="p">(</span><span class="n">index_lr</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
            <span class="n">columns_sql_str</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_sql</span><span class="p">),</span>
            <span class="n">join</span><span class="o">=</span><span class="n">how</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
            <span class="n">left_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_node</span><span class="p">,</span>
            <span class="n">right_node</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">base_node</span><span class="p">,</span>
            <span class="n">condition_str</span><span class="o">=</span><span class="n">condition_str</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">BuhTuhDataFrame</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">source_node</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">index_dtypes</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
            <span class="n">dtypes</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_series</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="BuhTuhSeries"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries">[docs]</a><span class="k">class</span> <span class="nc">BuhTuhSeries</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Immutable class representing a column/expression in a query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">engine</span><span class="p">,</span>
                 <span class="n">base_node</span><span class="p">:</span> <span class="n">SqlModel</span><span class="p">,</span>
                 <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">]],</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: docstring</span>
<span class="sd">        :param engine:</span>
<span class="sd">        :param base_node:</span>
<span class="sd">        :param index: None if this Series is part of an index. Otherwise a dict with the Series that are</span>
<span class="sd">                        this Series&#39; index</span>
<span class="sd">        :param name:</span>
<span class="sd">        :param expression:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_node</span> <span class="o">=</span> <span class="n">base_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># todo: change expression in an ast-like object, that can be a constant, column, operator, and/or</span>
        <span class="c1">#   refer other series</span>
        <span class="k">if</span> <span class="n">expression</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expression</span> <span class="o">=</span> <span class="n">expression</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">table_alias</span><span class="se">}}</span><span class="s1">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="BuhTuhSeries.constant_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.constant_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">constant_to_sql</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="BuhTuhSeries.from_dtype_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.from_dtype_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">from_dtype_to_sql</span><span class="p">(</span><span class="n">source_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_node</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SqlModel</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_node</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expression</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expression</span>

<div class="viewcode-block" id="BuhTuhSeries.head"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.head">[docs]</a>    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the first `n` rows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO get a series directly instead of ripping it out of the df?</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span></div>

<div class="viewcode-block" id="BuhTuhSeries.sort_values"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.sort_values">[docs]</a>    <span class="k">def</span> <span class="nf">sort_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_order</span><span class="p">):</span>
        <span class="c1"># TODO sort series directly instead of ripping it out of the df?</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_order</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span></div>

<div class="viewcode-block" id="BuhTuhSeries.view_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.view_sql">[docs]</a>    <span class="k">def</span> <span class="nf">view_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">view_sql</span><span class="p">()</span></div>

<div class="viewcode-block" id="BuhTuhSeries.to_frame"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.to_frame">[docs]</a>    <span class="k">def</span> <span class="nf">to_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BuhTuhDataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;to_frame() is not supported for Series that do not have an index&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">BuhTuhDataFrame</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">source_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_node</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">series</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhSeries.get_instance"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.get_instance">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_instance</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span>
            <span class="n">base</span><span class="p">:</span> <span class="n">DataFrameOrSeries</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of the right sub-class of BuhTuhSeries.</span>
<span class="sd">        The subclass is based on the provided dtype. See docstring of __init__ for other parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">series_type</span> <span class="o">=</span> <span class="n">get_series_type_from_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">series_type</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">base_node</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">base_node</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">expression</span><span class="o">=</span><span class="n">expression</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhSeries.get_expression"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.get_expression">[docs]</a>    <span class="k">def</span> <span class="nf">get_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_alias</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># TODO BLOCKER! escape the stuff</span>

        <span class="k">if</span> <span class="n">table_alias</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">table_alias</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
            <span class="n">table_alias</span> <span class="o">=</span> <span class="n">table_alias</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_alias</span><span class="o">=</span><span class="n">table_alias</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhSeries.get_column_expression"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.get_column_expression">[docs]</a>    <span class="k">def</span> <span class="nf">get_column_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_alias</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># TODO BLOCKER! escape the stuff</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">table_alias</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expression</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1"> as &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span></div>

    <span class="k">def</span> <span class="nf">_check_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">supported_dtypes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_node</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">base_node</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Operations on different graph nodes are currently not supported.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_dtypes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s1"> not supported between </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_derived_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BuhTuhSeries</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span>
            <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">new_dtype</span><span class="p">,</span>
            <span class="n">expression</span><span class="o">=</span><span class="n">expression</span>
        <span class="p">)</span>

<div class="viewcode-block" id="BuhTuhSeries.astype"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.astype">[docs]</a>    <span class="k">def</span> <span class="nf">astype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">series_type</span> <span class="o">=</span> <span class="n">get_series_type_from_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">series_type</span><span class="o">.</span><span class="n">from_dtype_to_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="n">new_dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="n">expression</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhSeries.from_const"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.from_const">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_const</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                   <span class="n">base</span><span class="p">:</span> <span class="n">DataFrameOrSeries</span><span class="p">,</span>
                   <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
                   <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># needed for mypy</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">BuhTuhSeries</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span>
            <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">expression</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">constant_to_sql</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="c1"># Below methods are not abstract, as they can be optionally be implemented by subclasses.</span>
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c1"># TODO, answer: What about __matmul__?</span>

    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__floordiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c1"># TODO, answer: What about __divmod__?</span>

    <span class="k">def</span> <span class="fm">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">modulo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__lshift__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__rshift__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__xor__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_comparator_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">comparator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesBoolean&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesBoolean&#39;</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator_operator</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s2">&quot;&lt;&gt;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesBoolean&#39;</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator_operator</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesBoolean&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator_operator</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesBoolean&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator_operator</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesBoolean&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator_operator</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesBoolean&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator_operator</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;index slices currently not supported&quot;</span><span class="p">)</span>

        <span class="c1"># any other value we treat as a literal index lookup</span>
        <span class="c1"># multiindex not supported atm</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Function not supported on Series without index&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Index only implemented for simple indexes.&#39;</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>

        <span class="c1"># this is massively ugly</span>
        <span class="k">return</span> <span class="n">series</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Maybe the aggregation methods should be defined on a more subclass of the actual Series call</span>
    <span class="c1"># so we can be more restrictive in calling these.</span>
<div class="viewcode-block" id="BuhTuhSeries.min"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.min">[docs]</a>    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;min(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhSeries.max"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.max">[docs]</a>    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;max(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhSeries.count"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;count(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhSeries.nunique"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeries.nunique">[docs]</a>    <span class="k">def</span> <span class="nf">nunique</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;count(distinct </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BuhTuhSeriesBoolean"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesBoolean">[docs]</a><span class="k">class</span> <span class="nc">BuhTuhSeriesBoolean</span><span class="p">(</span><span class="n">BuhTuhSeries</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;bool&quot;</span>

<div class="viewcode-block" id="BuhTuhSeriesBoolean.constant_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesBoolean.constant_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">constant_to_sql</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;value should be bool, actual type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhSeriesBoolean.from_dtype_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesBoolean.from_dtype_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_dtype_to_sql</span><span class="p">(</span><span class="n">source_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source_dtype</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">)::bool&#39;</span></div>

    <span class="k">def</span> <span class="nf">_boolean_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">operator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesBoolean&#39;</span><span class="p">:</span>
        <span class="c1"># TODO maybe &quot;other&quot; should have a way to tell us it can be a bool?</span>
        <span class="c1"># TODO we&#39;re missing &quot;NOT&quot; here. https://www.postgresql.org/docs/13/functions-logical.html</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;boolean operator &#39;</span><span class="si">{</span><span class="n">operator</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;((</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">) </span><span class="si">{</span><span class="n">operator</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">::bool))&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;((</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">) </span><span class="si">{</span><span class="n">operator</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">))&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesBoolean&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boolean_operator</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;AND&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesBoolean&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boolean_operator</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;OR&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuhTuhSeriesAbstractNumeric"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesAbstractNumeric">[docs]</a><span class="k">class</span> <span class="nc">BuhTuhSeriesAbstractNumeric</span><span class="p">(</span><span class="n">BuhTuhSeries</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class that defines shared logic between BuhTuhSeriesInt64 and BuhTuhSeriesFloat64</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">) + (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="n">new_dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span> <span class="k">if</span> <span class="s1">&#39;float64&#39;</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;int64&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="n">new_dtype</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="s1">&#39;sub&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">) - (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="n">new_dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span> <span class="k">if</span> <span class="s1">&#39;float64&#39;</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;int64&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="n">new_dtype</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_comparator_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">comparator</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;comparator &#39;</span><span class="si">{</span><span class="n">comparator</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">) </span><span class="si">{</span><span class="n">comparator</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="s1">&#39;division&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)::float / (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__floordiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="s1">&#39;division&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)::int / (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)::int&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

<div class="viewcode-block" id="BuhTuhSeriesAbstractNumeric.sum"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesAbstractNumeric.sum">[docs]</a>    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: This cast here is rather nasty</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sum(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)::int&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BuhTuhSeriesInt64"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesInt64">[docs]</a><span class="k">class</span> <span class="nc">BuhTuhSeriesInt64</span><span class="p">(</span><span class="n">BuhTuhSeriesAbstractNumeric</span><span class="p">):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;Int64&#39;</span>

<div class="viewcode-block" id="BuhTuhSeriesInt64.constant_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesInt64.constant_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">constant_to_sql</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;value should be int, actual type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhSeriesInt64.from_dtype_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesInt64.from_dtype_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_dtype_to_sql</span><span class="p">(</span><span class="n">source_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source_dtype</span> <span class="o">==</span> <span class="s1">&#39;Int64&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">)::int&#39;</span></div></div>


<div class="viewcode-block" id="BuhTuhSeriesFloat64"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesFloat64">[docs]</a><span class="k">class</span> <span class="nc">BuhTuhSeriesFloat64</span><span class="p">(</span><span class="n">BuhTuhSeriesAbstractNumeric</span><span class="p">):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;Float64&#39;</span>

<div class="viewcode-block" id="BuhTuhSeriesFloat64.constant_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesFloat64.constant_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">constant_to_sql</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;value should be float, actual type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">::float&#39;</span></div>

<div class="viewcode-block" id="BuhTuhSeriesFloat64.from_dtype_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesFloat64.from_dtype_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_dtype_to_sql</span><span class="p">(</span><span class="n">source_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source_dtype</span> <span class="o">==</span> <span class="s1">&#39;Float64&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">)::float&#39;</span></div></div>


<div class="viewcode-block" id="BuhTuhSeriesString"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesString">[docs]</a><span class="k">class</span> <span class="nc">BuhTuhSeriesString</span><span class="p">(</span><span class="n">BuhTuhSeries</span><span class="p">):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span>

<div class="viewcode-block" id="BuhTuhSeriesString.constant_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesString.constant_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">constant_to_sql</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;value should be str, actual type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: fix sql injection!</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span></div>

<div class="viewcode-block" id="BuhTuhSeriesString.from_dtype_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesString.from_dtype_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_dtype_to_sql</span><span class="p">(</span><span class="n">source_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source_dtype</span> <span class="o">==</span> <span class="s1">&#39;String&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">)::varchar&#39;</span></div>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">:</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">) || (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_comparator_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">comparator</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;comparator &#39;</span><span class="si">{</span><span class="n">comparator</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">) </span><span class="si">{</span><span class="n">comparator</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

<div class="viewcode-block" id="BuhTuhSeriesString.slice"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesString.slice">[docs]</a>    <span class="k">def</span> <span class="nf">slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">],</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesString&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a python string slice using DB functions. Format follows standard slice format</span>
<span class="sd">        Note: this is called &#39;slice&#39; to not destroy index selection logic</span>
<span class="sd">        :param item: an int for a single character, or a slice for some nice slicing</span>
<span class="sd">        :return: BuhTuhSeriesString with the slice applied</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Type not supported </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span>

        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;right(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">stop</span> <span class="o">&gt;</span> <span class="n">item</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
                    <span class="c1"># we needed to check stop &lt; 0, because that would mean we&#39;re going the wrong direction</span>
                    <span class="c1"># and that&#39;s not supported</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;left(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">item</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="s2">&quot;&#39;&#39;&quot;</span>

        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># we need to get the full string, minus abs(stop) chars.</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;substr(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">, 1, greatest(0, length(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">)</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s1">))&#39;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># positives only</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># full string, what are we doing here?</span>
                    <span class="c1"># current expression is okay.</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># full string starting at start</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;substr(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;left(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">stop</span> <span class="o">&gt;</span> <span class="n">item</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
                        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;substr(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">stop</span><span class="o">-</span><span class="n">item</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s1">)&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">expression</span> <span class="o">=</span> <span class="s2">&quot;&#39;&#39;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BuhTuhSeriesTimestamp"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesTimestamp">[docs]</a><span class="k">class</span> <span class="nc">BuhTuhSeriesTimestamp</span><span class="p">(</span><span class="n">BuhTuhSeries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Types in PG that we want to support: https://www.postgresql.org/docs/9.1/datatype-datetime.html</span>
<span class="sd">        timestamp without time zone</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;timestamp&#39;</span>

    <span class="n">db_dtype</span> <span class="o">=</span> <span class="s1">&#39;timezone without time zone&#39;</span>

<div class="viewcode-block" id="BuhTuhSeriesTimestamp.constant_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesTimestamp.constant_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">constant_to_sql</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># This is wrong. We need a timedelta datatype</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">)):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;value should be str or (datetime.datetime, datetime.date, numpy.timedelta64)&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;, actual type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: fix sql injection!</span>
        <span class="c1"># Maybe we should do some checking on syntax here?</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span></div>

<div class="viewcode-block" id="BuhTuhSeriesTimestamp.from_dtype_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesTimestamp.from_dtype_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_dtype_to_sql</span><span class="p">(</span><span class="n">source_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source_dtype</span> <span class="o">==</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">::</span><span class="si">{</span><span class="n">BuhTuhSeriesTimestamp</span><span class="o">.</span><span class="n">db_dtype</span><span class="si">}</span><span class="s1">)&#39;</span></div>

    <span class="k">def</span> <span class="nf">_comparator_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">comparator</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;comparator &#39;</span><span class="si">{</span><span class="n">comparator</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">) </span><span class="si">{</span><span class="n">comparator</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

<div class="viewcode-block" id="BuhTuhSeriesTimestamp.format"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesTimestamp.format">[docs]</a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesString&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allow standard PG formatting of this Series (to a string type)</span>

<span class="sd">        :param format: The format as defined in https://www.postgresql.org/docs/9.1/functions-formatting.html</span>
<span class="sd">        :return: a derived Series that accepts and returns formatted timestamp strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;to_char(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s2">, &#39;</span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesTimestamp&#39;</span><span class="p">:</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="s1">&#39;sub&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">) - (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;timedelta&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuhTuhSeriesDate"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesDate">[docs]</a><span class="k">class</span> <span class="nc">BuhTuhSeriesDate</span><span class="p">(</span><span class="n">BuhTuhSeriesTimestamp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Types in PG that we want to support: https://www.postgresql.org/docs/9.1/datatype-datetime.html</span>
<span class="sd">        date</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
    <span class="n">db_dtype</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>

<div class="viewcode-block" id="BuhTuhSeriesDate.from_dtype_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesDate.from_dtype_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_dtype_to_sql</span><span class="p">(</span><span class="n">source_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source_dtype</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">::</span><span class="si">{</span><span class="n">BuhTuhSeriesDate</span><span class="o">.</span><span class="n">db_dtype</span><span class="si">}</span><span class="s1">)&#39;</span></div></div>


<div class="viewcode-block" id="BuhTuhSeriesTime"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesTime">[docs]</a><span class="k">class</span> <span class="nc">BuhTuhSeriesTime</span><span class="p">(</span><span class="n">BuhTuhSeriesTimestamp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Types in PG that we want to support: https://www.postgresql.org/docs/9.1/datatype-datetime.html</span>
<span class="sd">        time without time zone</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
    <span class="n">db_dtype</span> <span class="o">=</span> <span class="s1">&#39;time without time zone&#39;</span>

<div class="viewcode-block" id="BuhTuhSeriesTime.from_dtype_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesTime.from_dtype_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_dtype_to_sql</span><span class="p">(</span><span class="n">source_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source_dtype</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">::</span><span class="si">{</span><span class="n">BuhTuhSeriesTime</span><span class="o">.</span><span class="n">db_dtype</span><span class="si">}</span><span class="s1">)&#39;</span></div></div>


<div class="viewcode-block" id="BuhTuhSeriesTimedelta"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesTimedelta">[docs]</a><span class="k">class</span> <span class="nc">BuhTuhSeriesTimedelta</span><span class="p">(</span><span class="n">BuhTuhSeries</span><span class="p">):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;timedelta&#39;</span>
    <span class="n">db_dtype</span> <span class="o">=</span> <span class="s1">&#39;interval&#39;</span>

<div class="viewcode-block" id="BuhTuhSeriesTimedelta.constant_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesTimedelta.constant_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">constant_to_sql</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">)):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;value should be str or (datetime.datetime, datetime.date, numpy.timedelta64)&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;, actual type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: fix sql injection!</span>
        <span class="c1"># Maybe we should do some checking on syntax here?</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span></div>

<div class="viewcode-block" id="BuhTuhSeriesTimedelta.from_dtype_to_sql"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesTimedelta.from_dtype_to_sql">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_dtype_to_sql</span><span class="p">(</span><span class="n">source_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source_dtype</span> <span class="o">==</span> <span class="s1">&#39;timedelta&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s1">::</span><span class="si">{</span><span class="n">BuhTuhSeriesTimedelta</span><span class="o">.</span><span class="n">db_dtype</span><span class="si">}</span><span class="s1">)&#39;</span></div>

    <span class="k">def</span> <span class="nf">_comparator_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">comparator</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;comparator &#39;</span><span class="si">{</span><span class="n">comparator</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;timedelta&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">) </span><span class="si">{</span><span class="n">comparator</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

<div class="viewcode-block" id="BuhTuhSeriesTimedelta.format"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesTimedelta.format">[docs]</a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesString&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allow standard PG formatting of this Series (to a string type)</span>

<span class="sd">        :param format: The format as defined in https://www.postgresql.org/docs/9.1/functions-formatting.html</span>
<span class="sd">        :return: a derived Series that accepts and returns formatted timestamp strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;to_char(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s2">, &#39;</span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesTimedelta&#39;</span><span class="p">:</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;timedelta&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">) + (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;timedelta&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesTimedelta&#39;</span><span class="p">:</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="s1">&#39;sub&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;timedelta&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">other</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">) - (</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;timedelta&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

<div class="viewcode-block" id="BuhTuhSeriesTimedelta.sum"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesTimedelta.sum">[docs]</a>    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesTimedelta&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;timedelta&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sum(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuhTuhSeriesTimedelta.average"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhSeriesTimedelta.average">[docs]</a>    <span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhSeriesTimedelta&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derived_series</span><span class="p">(</span><span class="s1">&#39;timedelta&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;avg(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BuhTuhGroupBy"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhGroupBy">[docs]</a><span class="k">class</span> <span class="nc">BuhTuhGroupBy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">buh_tuh</span><span class="p">:</span> <span class="n">BuhTuhDataFrame</span><span class="p">,</span>
                 <span class="n">group_by_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;BuhTuhSeries&#39;</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buh_tuh</span> <span class="o">=</span> <span class="n">buh_tuh</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">groupby</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">group_by_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported groupby argument type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">col</span><span class="o">.</span><span class="n">base_node</span> <span class="o">==</span> <span class="n">buh_tuh</span><span class="o">.</span><span class="n">base_node</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_by_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># create new dummy column so we can aggregate over everything</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupby</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">BuhTuhSeriesInt64</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">buh_tuh</span><span class="p">,</span>
                                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span>
                                                        <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span>
                                                        <span class="n">expression</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aggregated_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">series</span>
                                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">buh_tuh</span><span class="o">.</span><span class="n">all_series</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

<div class="viewcode-block" id="BuhTuhGroupBy.aggregate"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.BuhTuhGroupBy.aggregate">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="n">aggregations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BuhTuhDataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute requested aggregations on this groupby</span>

<span class="sd">        :param series: a dict containing &#39;name&#39;: &#39;aggregation_method&#39;.</span>
<span class="sd">            In case you need duplicates: a list of &#39;name&#39;s is also supported, but aggregations should have</span>
<span class="sd">            the same length list with the aggregation methods requested</span>
<span class="sd">        :param aggregations: The aggregation methods requested in case series is a list.</span>
<span class="sd">        :return: a new BuhTuhDataFrame containing the requested aggregations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_series_dtypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">aggregate_columns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aggregations</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;aggregations must be a list if series is a list&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aggregations</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Length of series should match length of aggregations: &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">aggregations</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">aggregations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">series</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">aggregation</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">aggregations</span><span class="p">)):</span>
            <span class="n">data_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregated_data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data_series</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">)</span>
            <span class="n">agg_series</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">agg_series</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">aggregation</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">agg_series</span> <span class="o">=</span> <span class="n">BuhTuhSeries</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buh_tuh</span><span class="p">,</span>
                                                   <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                                   <span class="n">dtype</span><span class="o">=</span><span class="n">agg_series</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                                   <span class="n">expression</span><span class="o">=</span><span class="n">agg_series</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
            <span class="n">aggregate_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agg_series</span><span class="o">.</span><span class="n">get_column_expression</span><span class="p">())</span>
            <span class="n">new_series_dtypes</span><span class="p">[</span><span class="n">agg_series</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_series</span><span class="o">.</span><span class="n">dtype</span>

        <span class="n">model_builder</span> <span class="o">=</span> <span class="n">CustomSqlModel</span><span class="p">(</span>  <span class="c1"># setting this stuff could also be part of __init__</span>
            <span class="n">sql</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                select </span><span class="si">{group_by_columns}</span><span class="s2">, </span><span class="si">{aggregate_columns}</span><span class="s2"></span>

<span class="s2">                from {{prev}}</span>
<span class="s2">                group by </span><span class="si">{group_by_expression}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_builder</span><span class="p">(</span>
            <span class="n">group_by_columns</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">get_column_expression</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">aggregate_columns</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aggregate_columns</span><span class="p">),</span>
            <span class="n">group_by_expression</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">get_expression</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="c1"># TODO: get final node, or at least make sure we &#39;freeze&#39; the node?</span>
            <span class="n">prev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buh_tuh</span><span class="o">.</span><span class="n">base_node</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">BuhTuhDataFrame</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buh_tuh</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">source_node</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">index_dtypes</span><span class="o">=</span><span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
            <span class="n">dtypes</span><span class="o">=</span><span class="n">new_series_dtypes</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; All methods that do not exists yet are potential aggregation methods. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">({</span><span class="n">series_name</span><span class="p">:</span> <span class="n">attr_name</span> <span class="k">for</span> <span class="n">series_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregated_data</span><span class="p">})</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="s1">&#39;BuhTuhGroupBy&#39;</span><span class="p">:</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)),</span> <span class="sa">f</span><span class="s1">&#39;a buhtuh `selection` should be a str or list but &#39;</span> \
                                                    <span class="sa">f</span><span class="s1">&#39;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s1"> instead.&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">key_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="c1"># todo: check that the key_set is not in group_by_data, or make sure we fix the duplicate column</span>
        <span class="c1">#  name problem?</span>
        <span class="k">assert</span> <span class="n">key_set</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregated_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="n">selected_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">data</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregated_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_set</span><span class="p">}</span>
        <span class="n">buh_tuh</span> <span class="o">=</span> <span class="n">BuhTuhDataFrame</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buh_tuh</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">source_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buh_tuh</span><span class="o">.</span><span class="n">base_node</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="p">,</span>
            <span class="n">series</span><span class="o">=</span><span class="n">selected_data</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">BuhTuhGroupBy</span><span class="p">(</span><span class="n">buh_tuh</span><span class="o">=</span><span class="n">buh_tuh</span><span class="p">,</span> <span class="n">group_by_columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span></div>


<div class="viewcode-block" id="const_to_series"><a class="viewcode-back" href="../../api/buhtuh.pandasql.html#buhtuh.pandasql.const_to_series">[docs]</a><span class="k">def</span> <span class="nf">const_to_series</span><span class="p">(</span><span class="n">base</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BuhTuhSeries</span><span class="p">,</span> <span class="n">BuhTuhDataFrame</span><span class="p">],</span>
                    <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BuhTuhSeries</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BuhTuhSeries</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take a value and return a BuhTuhSeries representing a column with that value.</span>
<span class="sd">    If value is already a BuhTuhSeries it is returned unchanged.</span>
<span class="sd">    If value is a constant then the right BuhTuhSeries subclass is found for that type and instantiated</span>
<span class="sd">    with the constant value.</span>
<span class="sd">    :param base: Base series or DataFrame. In case a new Series object is created and returned, it will</span>
<span class="sd">        share its engine, index, and base_node with this one. Only applies if value is not a BuhTuhSeries</span>
<span class="sd">    :param value: constant value for which to create a Series, or a BuhTuhSeries</span>
<span class="sd">    :param name: optional name for the series object. Only applies if value is not a BuhTuhSeries</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;__tmp&#39;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">arg_to_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">series_type</span> <span class="o">=</span> <span class="n">get_series_type_from_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">series_type</span><span class="o">.</span><span class="n">from_const</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>
</pre></div>

              </div>
              
              
              <div class='prev-next-bottom'>
                

              </div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../_static/js/index.baa8d61b9335871b5b4b.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, bt.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>