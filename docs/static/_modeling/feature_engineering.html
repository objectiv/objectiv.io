<div>
                
  <section id="feature-engineering-with-bach">
<span id="example-feature-engineering"/><h1>Feature engineering with Bach<a class="headerlink" href="#feature-engineering-with-bach" title="Permalink to this headline">#</a></h1>
<p>This example shows how Bach can be used for feature engineering. We&#8217;ll go through describing the data, finding
outliers, transforming data and grouping and aggregating data so that a useful feature set is created that
can be used for machine learning. We have a separate example available that goes into the details of how a
data set prepared in Bach can be used for machine learning with sklearn
<a class="reference internal" href="machine_learning.html#example-machine-learning"><span class="std std-ref">here</span></a>.</p>
<p>This example is also available in a <a class="reference external" href="https://github.com/objectiv/objectiv-analytics/blob/main/notebooks/feature_engineering.ipynb">notebook</a>
to run on your own data or use our
<a class="reference external" href="https://objectiv.io/docs/home/quickstart-guide/">quickstart</a> to try it out with demo data in 5 minutes.</p>
<p>At first we have to instantiate the Objectiv DataFrame object. See
<a class="reference internal" href="example_notebooks.html#get-started-with-objectiv"><span class="std std-ref">Getting started with Objectiv</span></a> for more info on how to instantiate the object.</p>
<p>This object points to all data in the data set. Too large to run in pandas and therefore sklearn. For the
data set that we need, we aggregate to user level, at which point it is small enough to fit in memory.</p>
<p>We start with showing the first couple of rows from the data set and describing the entire data set.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p>Columns of interest are &#8216;user_id&#8217;, this is what we will aggregate to. &#8216;moment&#8217; contains timestamp info for the
events. <a class="reference internal" href="open_taxonomy.html#global-contexts"><span class="std std-ref">global_contexts</span></a> and the <a class="reference internal" href="open_taxonomy.html#location-stack"><span class="std std-ref">location_stack</span></a> contain most of the event specific data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s1">'all'</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<section id="creating-a-feature-set">
<h2>Creating a feature set<a class="headerlink" href="#creating-a-feature-set" title="Permalink to this headline">#</a></h2>
<p>We&#8217;d like to create a feature set that describes the behaviour of users in a way. We start with extracting
the root location from the location stack. This indicates what parts of our website users have visited. Using
<cite>to_numpy()</cite> shows the results as a numpy array.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="n">df</span><span class="p">[</span><span class="s1">'root'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">location_stack</span><span class="o">.</span><span class="n">ls</span><span class="o">.</span><span class="n">get_from_context_with_type_series</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">'RootLocationContext'</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">'id'</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</pre></div>
</div>
<p><cite>[&#8216;jobs&#8217;, &#8216;docs&#8217;, &#8216;home&#8217;&#8230;]</cite> etc is returned, the sections of the objectiv.io website.</p>
</section>
<section id="check-missing-values">
<h2>Check missing values<a class="headerlink" href="#check-missing-values" title="Permalink to this headline">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="n">df</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p>A quick check learns us that there are no missing values to worry about. Now we want a data set with
interactions on our different sections, in particular, presses. This is an event type. We first want an
overview of the different event types that exist and select the one we are interested in.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="n">df</span><span class="o">.</span><span class="n">event_type</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</pre></div>
</div>
<p>We are interested in &#8216;PressEvent&#8217;.</p>
</section>
<section id="creating-the-variables">
<h2>Creating the variables<a class="headerlink" href="#creating-the-variables" title="Permalink to this headline">#</a></h2>
<p>The next code block shows that we select only press events and then group
by &#8216;user_id&#8217; and &#8216;root&#8217; and count the session_hit_number. After that the results are unstacked, resulting in
a table where each row represents a user (the index is &#8216;user_id&#8217;) and the columns are the different root
locations and its values are the number of times a user clicked in that sections.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">event_type</span><span class="o">==</span><span class="s1">'PressEvent'</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'user_id'</span><span class="p">,</span><span class="s1">'root'</span><span class="p">])</span><span class="o">.</span><span class="n">session_hit_number</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">features_unstacked</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
<span class="n">features_unstacked</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="fill-empty-values">
<h2>Fill empty values<a class="headerlink" href="#fill-empty-values" title="Permalink to this headline">#</a></h2>
<p>Now we do have empty values, so we fill them with 0, as empty means that the user did not click in the
section.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="n">features_unstacked</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="describe-the-data-set">
<h2>Describe the data set<a class="headerlink" href="#describe-the-data-set" title="Permalink to this headline">#</a></h2>
<p>We use describe again to get an impression of out created per-user data set.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="n">features_unstacked</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p>Looking at the mean, some sections seem to be used a lot more than others. Also the max
number of clicks seems quite different per root section. This information can be used to drop some of the
variables from our data set or the use scaling or outlier detection. We will plot histograms for the</p>
</section>
<section id="visualize-the-data">
<h2>Visualize the data<a class="headerlink" href="#visualize-the-data" title="Permalink to this headline">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features_unstacked</span><span class="o">.</span><span class="n">data_columns</span><span class="p">):</span>
    <span class="n">df_bins</span> <span class="o">=</span> <span class="n">features_unstacked</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">df_bins</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">'bar'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<p>The histograms show that indeed the higher values seem quite anomalous for most of the root locations. This
could be a reason to drop some of these observations or resort to scaling methods. For now we continue with
the data set as is.</p>
</section>
<section id="add-time-feature">
<h2>Add time feature<a class="headerlink" href="#add-time-feature" title="Permalink to this headline">#</a></h2>
<p>Now we want to add some time feature to our data set. We add the average session length per user to the data
set. We can use the model hub for this. <cite>fillna</cite> is used to fill missing values.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">datetime</span>
<span class="n">features_unstacked</span><span class="p">[</span><span class="s1">'session_duration'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mh</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">session_duration</span><span class="p">(</span><span class="n">groupby</span><span class="o">=</span><span class="s1">'user_id'</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="export-to-pandas-for-sklearn">
<h2>Export to pandas for sklearn<a class="headerlink" href="#export-to-pandas-for-sklearn" title="Permalink to this headline">#</a></h2>
<p>Now that we have our data set, we can use it for machine learning, using for example sklearn. To do so
we call <cite>to_pandas()</cite> to get a pandas DataFrame that can be used in sklearn.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="n">pdf</span> <span class="o">=</span> <span class="n">features_unstacked</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>


              </div>
              
              
              